---------------------
pr_surescript_formulary_coverage
---------------------
ALTER PROCEDURE "DBA"."pr_surescript_formulary_coverage"( 
  in ae_patient_id numeric(10),
  in ae_eligibility_id numeric(12),
  in as_sender_id varchar(100),
  in as_product_id varchar(100),
  in as_coverage_id varchar(100),
  in as_alternative_id varchar(100),
  in as_copay_id varchar(100),
  in as_formulary_id varchar(100) ) 
result( 
  sort_order numeric(2),
  group_name varchar(100),
  coverage_type_code char(2),
  record_id numeric(12),
  sr_id numeric(12),
  alert_flag char(1),
  coverage_type varchar(100),
  coverage_desc varchar(10000),
  extra_column_1 varchar(1000),
  extra_column_2 varchar(1000) ) 
begin
  select * from 
(
  select 11 as sort_order,
    'Coverage' as group_name,
    'AL' as coverage_type_code,
    formulary_coverage_al_detail.record_id as record_id,
    /*formulary_coverage_al_detail.sr_id*/ 0 as sr_id,
    'N' as alert_flag,
    'Age Limit' as coverage_type,
    String(min_age)+if min_age_qualifier = 'D' then ' Days' else ' Years' endif+' - '+String(max_age)+if max_age_qualifier = 'D' then ' Days' else ' Years' endif as coverage_desc,
    '' as extra_column_1,
    '' as extra_column_2
    from formulary_coverage_al_detail,formulary_coverage_header
    where formulary_coverage_al_detail.record_id = formulary_coverage_header.record_id
    and formulary_coverage_header.sender_id = as_sender_id
    and formulary_coverage_al_detail.product_id  IN ( select ndc from ndc_mst where PLBLR ='0' and REPACK = '0' and ud = '0' and OBSDTEC ='00000000' and   ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and formulary_coverage_al_detail.coverage_id = as_coverage_id 
   /* and(formulary_coverage_al_detail.min_age > 0 or formulary_coverage_al_detail.max_age > 0) */ union all
  select 12 as sort_order,
    'Coverage' as group_name,
    'GL' as coverage_type_code,
    formulary_coverage_gl_detail.record_id as record_id,
    /*formulary_coverage_gl_detail.sr_id*/ 0 as sr_id,
    'N' as alert_flag,
    'Gender Limit' as coverage_type,
    if gender = '1' then 'Male' else 'Female' endif as coverage_desc,
    '' as extra_column_1,
    '' as extra_column_2
    from formulary_coverage_gl_detail,formulary_coverage_header
    where formulary_coverage_gl_detail.record_id = formulary_coverage_header.record_id
    and formulary_coverage_header.sender_id = as_sender_id
    and formulary_coverage_gl_detail.product_id  IN ( select ndc from ndc_mst where   ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and formulary_coverage_gl_detail.coverage_id = as_coverage_id
    and(formulary_coverage_gl_detail.gender in( '1','2' ) ) union all
  select 14 as sort_order,
    'Coverage' as group_name,
    'QL' as coverage_type_code,
    formulary_coverage_ql_detail.record_id as record_id,
    /*formulary_coverage_ql_detail.sr_id */ 0 as sr_id,
    'N' as alert_flag,
    'Quantity Limit' as coverage_type,
    if max_amt > 0 then String(max_amt)+' '+(case max_amt_qualifier when 'DL' then 'Dollar Amount' when 'DS' then 'Days Supply' when 'FL' then 'Fills' when 'QY' then 'Quantity' end)+' - ' else '' endif
    +if max_amt_time_period = 'SP' then 'Date Range ('+string(max_amt_time_period_startdate)+' - '+string(max_amt_time_period_enddate)+')' else string(max_amt_time_period_unit)+' '+(case max_amt_time_period when 'SP' then 'Date Range ('+string(max_amt_time_period_startdate)+' - '+string(max_amt_time_period_enddate)+')' when 'DY' then 'Days' when 'LT' then 'Life Time' when 'PD' then 'Per Dispensing' when 'CY' then 'Calendar Year' when 'CQ' then 'Calendar Quarter' when 'CM' then 'Calendar Month' end) endif as coverage_desc,
    '' as extra_column_1,
    '' as extra_column_2
    from formulary_coverage_ql_detail,formulary_coverage_header
    where formulary_coverage_ql_detail.record_id = formulary_coverage_header.record_id
    and formulary_coverage_header.sender_id = as_sender_id
    and formulary_coverage_ql_detail.product_id  IN ( select ndc from ndc_mst where     ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and formulary_coverage_ql_detail.coverage_id = as_coverage_id union all
  select 15 as sort_order,
    'Coverage' as group_name,
    formulary_coverage_header.coverage_type as coverage_type_code,
    formulary_coverage_de_pa_mn_st_detail.record_id as record_id,
    /*formulary_coverage_de_pa_mn_st_detail.sr_id */ 0  as sr_id,
    'N' as alert_flag,
    (case formulary_coverage_header.coverage_type when 'DE' then 'Excluded' when 'PA' then 'Prior Authorization' when 'MN' then 'Medical Necessity' when 'ST' then 'Step Therapy' end) as coverage_type,
    (case formulary_coverage_header.coverage_type when 'DE' then 'Yes' else 'Required' end) as coverage_desc,
    '' as extra_column_1,
    '' as extra_column_2
    from formulary_coverage_de_pa_mn_st_detail,formulary_coverage_header
    where formulary_coverage_de_pa_mn_st_detail.record_id = formulary_coverage_header.record_id
    and formulary_coverage_header.sender_id = as_sender_id
    and formulary_coverage_de_pa_mn_st_detail.product_id  IN ( select ndc from ndc_mst where    ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and formulary_coverage_de_pa_mn_st_detail.coverage_id = as_coverage_id union all
  select 16 as sort_order,
    'Coverage' as group_name,
    'SM' as coverage_type_code,
    formulary_coverage_sm_detail.record_id as record_id,
    /*formulary_coverage_sm_detail.sr_id */ 0 as sr_id,
    'N' as alert_flag,
    'Step Medications' as coverage_type,
    isnull((select ln60 from ndc_mst where ndc = step_product_id),step_product_id) +' - Order '+string(step_order) as coverage_desc,
    '' as extra_column_1,
    step_order as extra_column_2
    from formulary_coverage_sm_detail,formulary_coverage_header
    where formulary_coverage_sm_detail.record_id = formulary_coverage_header.record_id
    and formulary_coverage_header.sender_id = as_sender_id
    and formulary_coverage_sm_detail.product_id  IN ( select ndc from ndc_mst where   ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and formulary_coverage_sm_detail.coverage_id = as_coverage_id  union all
  select 17 as sort_order,
    'Coverage' as group_name,
    'TM' as coverage_type_code,
    formulary_coverage_tm_detail.record_id as record_id,
    /*formulary_coverage_tm_detail.sr_id */ 0 as sr_id,
    'N' as alert_flag,
    'Text Message' as coverage_type,
    message_short as coverage_desc,
    message_long as extra_column_1,
    '' as extra_column_2
    from formulary_coverage_tm_detail,formulary_coverage_header
    where formulary_coverage_tm_detail.record_id = formulary_coverage_header.record_id
    and formulary_coverage_header.sender_id = as_sender_id
    and formulary_coverage_tm_detail.product_id  IN ( select ndc from ndc_mst where     ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and formulary_coverage_tm_detail.coverage_id = as_coverage_id union all
  select 18 as sort_order,
    'Coverage' as group_name,
    'RD' as coverage_type_code,
    formulary_coverage_rd_detail.record_id as record_id,
   /* formulary_coverage_rd_detail.sr_id */ 0 as sr_id,
   ( case resource_link_type when 'GI' then 'N' else 'N' end) as alert_flag, /* DE added by bhavik */
    (case resource_link_type when 'DE' then 'Product Coverage Exclusion' when  'QL' then 'Quantity Limit' when 'AL' then 'Age Limit' when 'GL' then 'Gender Limit' when 'PA' then 'Prior Authorization' when 'ST' then 'Step Therapy' when 'MN' then 'Medical Necessity' when 'GI' then 'General Info' when 'CP' then 'Copay' else 'Formulary' end) as coverage_type,
    resource_url as coverage_desc,
    '' as extra_column_1,
    '' as extra_column_2
    from formulary_coverage_rd_detail,formulary_coverage_header
    where formulary_coverage_rd_detail.record_id = formulary_coverage_header.record_id
    and formulary_coverage_header.sender_id = as_sender_id
    and formulary_coverage_rd_detail.product_id  IN ( select ndc from ndc_mst where    ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and formulary_coverage_rd_detail.coverage_id = as_coverage_id union all
 select 18 as sort_order, /* Added by Bhavik */
    'Coverage' as group_name,
    'RS' as coverage_type_code,
    formulary_coverage_rs_detail.record_id as record_id,
   /* formulary_coverage_rs_detail.sr_id*/ 0 as sr_id,
    ( case resource_link_type when 'GI' then 'N' else 'N' end) as alert_flag,
    (case resource_link_type when 'DE' then 'Product Coverage Exclusion' when 'QL' then 'Quantity Limit' when 'AL' then 'Age Limit' when 'GL' then 'Gender Limit' when 'PA' then 'Prior Authorization' when 'ST' then 'Step Therapy' when 'MN' then 'Medical Necessity' when 'GI' then 'General Info' when 'CP' then 'Copay' else 'Formulary' end) as coverage_type,
    resource_url as coverage_desc,
    '' as extra_column_1,
    '' as extra_column_2
    from formulary_coverage_rs_detail,formulary_coverage_header
    where formulary_coverage_rs_detail.record_id = formulary_coverage_header.record_id
    and formulary_coverage_header.sender_id = as_sender_id
    and formulary_coverage_rs_detail.coverage_id = as_coverage_id 
) tab   order by sort_order ,extra_column_2
end
--------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------
pr_surescript_formulary_info
-------------------------------
CREATE PROCEDURE "DBA"."pr_surescript_formulary_info"( 
  in ae_patient_id numeric(10),
  in ae_eligibility_id numeric(12),
  in as_sender_id varchar(100),
  in as_product_id varchar(100),
  in as_coverage_id varchar(100),
  in as_alternative_id varchar(100),
  in as_copay_id varchar(100),
  in as_formulary_id varchar(100) ) 
result( 
  sort_order numeric(2),
  group_name varchar(100),
  coverage_type_code char(2),
  record_id numeric(12),
  sr_id numeric(12),
  alert_flag char(20),
  coverage_type varchar(100),
  coverage_desc varchar(10000),
  extra_column_1 varchar(1000),
  extra_column_2 varchar(1000),
  pharmacy_type char(1) ) 
begin
  declare ls_formulary_status varchar(100);
  declare ls_formulary_status_code varchar(100);
   //DECLARE ls_otc_rx varchar(5);
    DECLARE ls_brand_generic varchar(20);
    //Check whether drug is in exclusion list

   /* //Get Drug Type
    SELECT CASE CL WHEN 'O' THEN 'OTC' ELSE 'RX' END , 
           CASE  GNI WHEN '1' THEN 'Generic' WHEN '2' THEN 'Brand' ELSE 'Supplies' END 
    INTO ls_otc_rx ,ls_brand_generic
    FROM ndc_mst 
    WHERE ndc = as_product_id;
    
    If ls_otc_rx = 'OTC' Then 
        Set ls_brand_generic = ls_otc_rx + ' ' + ls_brand_generic 
    End If;
    */
    Set ls_brand_generic = of_GetDrug_BrandGenericOTC(as_product_id);
  //  If Locate(ls_brand_generic,'Supplies') = 0 Then
  //      Set ls_brand_generic = ls_brand_generic +  ' '  + 'Drug';   
  //  End If;
  select of_Get_Formulary_Status(as_sender_id,as_product_id,as_coverage_id,as_formulary_id) as coverage_desc
    into ls_formulary_status from dummy;
  set ls_formulary_status_code = trim("Left"(ls_formulary_status,2));

  select 1 as sort_order,
    'Formulary Status' as group_name,
    '-3' as coverage_type_code,
    0,
    0, 
    'N' as alert_flag,
    'DONOTDISPLAY' as coverage_type,
    ls_formulary_status as coverage_desc,
    ls_formulary_status_code as extra_column_1,
    ls_brand_generic as extra_column_2,
    '' as pharmacy_type
    from dummy

 union all 
  select distinct 2 as sort_order,
    'Copay' as group_name,
    '-1' as coverage_type_code,
    formulary_copay_ds_detail.record_id,
   /* formulary_copay_ds_detail.sr_id*/ 0,
    'N' as alert_flag,
    'Drug Specific' as coverage_type,
    if flat_copay_amount > 0 then '$'+string(flat_copay_amount)+' | ' else '' endif
    +if percentage_copay_rate > 0 then string(percentage_copay_rate*100)+'% | ' else '' endif
    +(case first_copay_term when 'F' then 'First Copay: $ | ' when 'P' then 'First Copay: % | ' else '' end)
    +if min_copay > 0 then 'Min: $'+string(min_copay)+' | ' else '' endif
    +if max_copay > 0 then 'Max: $'+string(max_copay)+' | ' else '' endif
    +if days_supply > 0 then 'Days Supply: '+string(days_supply)+' | ' else '' endif
    +if copay_tier > 0 then 'Tier: '+string(copay_tier)+' | ' else '' endif
    +if max_copay_tier > 0 then 'Max. Tier: '+string(max_copay_tier)+' | ' else '' endif
    +If isnull(pharmacy_type,'') = '' then '' else 'Pharmacy Type: ' + (case pharmacy_type when 'A' then 'Any (A)' when 'M' then 'Mail Order (M)' when 'R' then 'Retail (R)' when 'S' then 'Specialty (S)' when 'L' then 'Long-Term Care(L)' else '' end) endif
    +if copay_tier > 0 or max_copay_tier > 0 then '\n(Lower tier number means less expense for the patient)' else '' endif as coverage_desc,
    '' as extra_column_1,
    '' as extra_column_2,
    pharmacy_type as pharmacy_type
    from formulary_copay_ds_detail,formulary_copay_header
    where formulary_copay_ds_detail.record_id = formulary_copay_header.record_id
    and formulary_copay_header.sender_id = as_sender_id
    and formulary_copay_ds_detail.copay_id = as_copay_id
    and formulary_copay_ds_detail.product_id  IN ( select ndc from ndc_mst where PLBLR ='0' and REPACK in ('0','1') and ud = '0' and OBSDTEC ='00000000'   and    ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and ls_formulary_status_code <> '0'   
 union all
  select distinct 3 as sort_order,
    'Copay' as group_name,
    '-1' as coverage_type_code, 
    formulary_copay_sl_detail.record_id,
   /* formulary_copay_sl_detail.sr_id */0,
    'N' as alert_flag,
    'Summary' as coverage_type,
   (case pharmacy_type when 'R' then 'Retail: ' when 'M' then 'Mail Order: ' when 'S' then 'Specialty: ' else 'Other: ' end)
    +if out_pocket_start_range > 0 then 'Out of Pocket Min: '+string(out_pocket_start_range)+' | ' else '' endif
    +if out_pocket_start_end > 0 then 'Out of Pocket Max: '+string(out_pocket_start_end)+' | ' else '' endif
    +if flat_copay_amount > 0 then '$'+string(flat_copay_amount)+' | ' else '' endif
    +if percentage_copay_rate > 0 then string(percentage_copay_rate*100)+'% | ' else '' endif
    +(case flat_copay_term when 'F' then 'First Copay: $ | ' when 'P' then 'First Copay: % | ' else '' end)
    +if  isnull(min_copay,-1) <> -1 then 'Min: $'+string(min_copay)+' | ' else '' endif
    +if isnull(max_copay,-1) <> -1 then 'Max: $'+string(max_copay)+' | ' else '' endif
    +if days_supply > 0 then 'Days Supply: '+string(days_supply)+' | ' else '' endif
    +if copay_tier > 0 then 'Tier: '+string(copay_tier)+' | ' else '' endif
    +if max_copay_tier > 0 then 'Max. Tier: '+string(max_copay_tier)+' | ' else '' endif
    +If isnull(pharmacy_type,'') = '' then '' else 'Pharmacy Type: ' + (case pharmacy_type when 'A' then 'Any (A)' when 'M' then 'Mail Order (M)' when 'R' then 'Retail (R)' when 'S' then 'Specialty (S)' when 'L' then 'Long-Term Care(L)' else '' end) endif
 
    +if copay_tier > 0 or max_copay_tier > 0 then '\n(Lower tier number means less expense for the patient)' else '' endif as coverage_desc,
    '' as extra_column_1,
    '' as extra_column_2,
    pharmacy_type as pharmacy_type
    from formulary_copay_sl_detail,formulary_copay_header
    where formulary_copay_sl_detail.record_id = formulary_copay_header.record_id
    and formulary_copay_header.sender_id = as_sender_id
    and formulary_copay_sl_detail.copay_id = as_copay_id
    and formulary_copay_sl_detail.formulary_status like ls_formulary_status_code
    and  ls_formulary_status_code <> '0'  and
    not exists (select a.record_id from formulary_copay_ds_detail a,formulary_copay_header b
    where a.record_id = b.record_id 
    and b.sender_id = as_sender_id
    and a.copay_id = as_copay_id
    and a.product_id  IN ( select ndc from ndc_mst where PLBLR ='0' and REPACK = '0' and ud = '0' and OBSDTEC ='00000000'   and    ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and ls_formulary_status_code <> '0' )
 union all
  select distinct 31 as sort_order,
    'Alternative Drug' as group_name,
    '-2' as coverage_type_code,
    formulary_alternative_detail.record_id,
    formulary_alternative_detail.sr_id,
    isnull(of_GetDrug_BrandGenericOTC( alternative_ndc.ndc) ,'') as alert_flag,
    'ALTERNATIVE' as coverage_type,
    alternative_ndc.ndc as coverage_desc,    
     if formulary_alternative_detail.preference_level > 0 then of_Get_Formulary_Status(as_sender_id,coverage_desc,as_coverage_id,as_formulary_id) else '' endif as extra_column_1,
    //if formulary_alternative_detail.preference_level > 0 then  string(formulary_alternative_detail.preference_level + 1 , ' = Preferred Level ', formulary_alternative_detail.preference_level) else '' endif as extra_column_1,
    alternative_ndc.ln60 as extra_column_2,
    '' as pharmacy_type
    from formulary_alternative_detail,formulary_alternative_header ,ndc_mst as  alternative_ndc
    where formulary_alternative_detail.record_id = formulary_alternative_header.record_id  and ("alternative_ndc"."active") is not NULL  
    and formulary_alternative_header.sender_id = as_sender_id
    and formulary_alternative_detail.alternative_id = as_alternative_id 
    and alternative_ndc.bn = (select bn from  ndc_mst where  ndc = formulary_alternative_detail.alternative_product_id) 
    and alternative_ndc.ndc  in  (select max(a.ndc) from  ndc_mst a  where  a.bn  = (select bn from  ndc_mst where  ndc = formulary_alternative_detail.alternative_product_id)  and a.PLBLR ='0' and a.REPACK = '0' and a.ud = '0' and a.OBSDTEC ='00000000'    group by a.ln60) 
    and formulary_alternative_detail.product_id  IN ( select ndc from ndc_mst where PLBLR ='0' and REPACK = '0' and ud = '0' and OBSDTEC ='00000000'   and    ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
union all
select * from (
 select 31 as sort_order, 
    'Therapeutic Alternative Drug' as group_name,
    '-2' as coverage_type_code,
    0 as record_id, 
    0 as sr_id ,
    isnull(of_GetDrug_BrandGenericOTC(MIN("ndc_mst"."ndc")) ,'') as alert_flag,
    'ALTERNATIVE'  as coverage_type,
    MAX("ndc_mst"."ndc") ndc_code  ,
    of_Get_Formulary_Status(as_sender_id,ndc_code,as_coverage_id,as_formulary_id)  as extra_column_1  ,
    isnull((select top 1 a.ln60 from ndc_mst a where a.ndc = ndc_code order by a.ln60) , 'NDC=' + ndc_code) as extra_column_2  ,
    '' as pharmacy_type
  
FROM "ndc_mst", "gcnseq_mst", "hicl_mst", "doseform_mst", "medication_mst", "ndc_medication_lnk", "ndc_label_mst" 
WHERE ( "ndc_mst"."gcn_seqno" = "gcnseq_mst"."gcn_seqno" ) and ("ndc_mst"."active") is not NULL  and 
      ( "gcnseq_mst"."hicl_seqno" = "hicl_mst"."hicl_seqno" ) and
      ( "gcnseq_mst"."gcdf" = "doseform_mst"."gcdf" ) and 
      ( "ndc_mst"."ndc" = "ndc_medication_lnk"."ndc" ) and 
      ( "ndc_medication_lnk"."medid" = "medication_mst"."medid" ) and
      ( "ndc_mst"."lblrid" = "ndc_label_mst"."lblrid" ) and  ndc_mst.obc3 = 'AB' and gti = '3' and 
        ndc_mst.PLBLR ='0' and ndc_mst.REPACK = '0' and ndc_mst.ud = '0' and  ndc_mst.OBSDTEC ='00000000'   and 
        ndc_mst.gcn_seqno in (select  gcn_seqno from "GCNSEQ_MST" where hic3  in (select b.HIC3 from ndc_mst a  ,gcnseq_mst b where a.gcn_seqno =  b.gcn_seqno and  a.ndc = as_product_id)) and
        ls_formulary_status_code  in ('0' ,'1')
GROUP BY "ndc_mst"."ln60", "ndc_mst"."gcn_seqno", "ndc_mst"."dea", "hicl_mst"."gnn", "doseform_mst"."dose", "medication_mst"."med_strength",
 "medication_mst"."med_strength_uom", "ndc_medication_lnk"."medid" , "ndc_mst"."bn"
) ther_alt where trim(left(extra_column_1,2)) not in( '0' ,'U','1')
 union all 
 
  select distinct *,'' from pr_surescript_formulary_coverage(ae_patient_id,ae_eligibility_id,as_sender_id,as_product_id,as_coverage_id,as_alternative_id,as_copay_id,as_formulary_id)

end;
-------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------
pr_surescript_formulary_info_quick
-------------------------
CREATE PROCEDURE "DBA"."pr_surescript_formulary_info_quick"( 
  in ae_patient_id numeric(10),
  in ae_eligibility_id numeric(12),
  in as_sender_id varchar(100),
  in as_product_id varchar(100),
  in as_coverage_id varchar(100),
  in as_alternative_id varchar(100),
  in as_copay_id varchar(100),
  in as_formulary_id varchar(100) ) 
result( 
  sort_order numeric(2),
  group_name varchar(100),
  coverage_type varchar(100),
  coverage_desc varchar(10000),
pharmacy_type char(1)) 
begin 
  declare ls_formulary_status_code varchar(100);
  declare ls_formulary_status varchar(100);
 
  select of_Get_Formulary_Status(as_sender_id,as_product_id,as_coverage_id,as_formulary_id) as coverage_desc
    into ls_formulary_status from dummy;
  set ls_formulary_status_code = "Left"(ls_formulary_status,1);
  select distinct 1 as sort_order,
    'Formulary Status' as group_name,
    'DONOTDISPLAY' as coverage_type,
    ls_formulary_status as coverage_desc,
    '' as pharmacy_type
    from dummy union all
  select distinct 2 as sort_order,
    'Drug Specific Copay' as group_name,
    'Drug Specific' as coverage_type,
    if flat_copay_amount > 0 then '$'+string(flat_copay_amount)+' | ' else '' endif
    +if percentage_copay_rate > 0 then string(percentage_copay_rate*100)+'% | ' else '' endif
    +(case first_copay_term when 'F' then 'First Copay: $ | ' when 'P' then 'First Copay: % | ' else '' end)
    +if min_copay > 0 then 'Min: $'+string(min_copay)+' | ' else '' endif
    +if max_copay > 0 then 'Max: $'+string(max_copay)+' | ' else '' endif
    +if days_supply > 0 then 'Days Supply: '+string(days_supply)+' | ' else '' endif
    +if copay_tier > 0 then 'Tier: '+string(copay_tier)+' | ' else '' endif
    +if max_copay_tier > 0 then 'Max. Tier: '+string(max_copay_tier)+' | ' else '' endif 
    +If isnull(pharmacy_type,'') = '' then '' else 'Pharmacy Type: ' + (case pharmacy_type when 'A' then 'Any (A)' when 'M' then 'Mail Order (M)' when 'R' then 'Retail (R)' when 'S' then 'Specialty (S)' when 'L' then 'Long-Term Care(L)' else '' end) endif as coverage_desc , pharmacy_type as pharmacy_type
    from formulary_copay_ds_detail,formulary_copay_header
    where formulary_copay_ds_detail.record_id = formulary_copay_header.record_id
    and formulary_copay_header.sender_id = as_sender_id
    and formulary_copay_ds_detail.copay_id = as_copay_id
    and formulary_copay_ds_detail.product_id IN ( select ndc from ndc_mst where PLBLR ='0' and REPACK in('0','1') and ud = '0' and OBSDTEC ='00000000' and    ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and ls_formulary_status_code <> '0'

    union all
  select distinct 3 as sort_order,
    'Summary Copay' as group_name,
    'Summary' as coverage_type,
    (case pharmacy_type when 'R' then 'Retail: ' when 'M' then 'Mail Order: ' when 'S' then 'Specialty: ' else 'Other: ' end)
    +if out_pocket_start_range > 0 then 'Out of Pocket Min: '+string(out_pocket_start_range)+' | ' else '' endif
    +if out_pocket_start_end > 0 then 'Out of Pocket Max: '+string(out_pocket_start_end)+' | ' else '' endif
    +if flat_copay_amount > 0 then '$'+string(flat_copay_amount)+' | ' else '' endif
    +if percentage_copay_rate > 0 then string(percentage_copay_rate*100)+'% | ' else '' endif
    +(case flat_copay_term when 'F' then 'First Copay: $ | ' when 'P' then 'First Copay: % | ' else '' end)
    +if min_copay > 0 then 'Min: $'+string(min_copay)+' | ' else '' endif
    +if max_copay > 0 then 'Max: $'+string(max_copay)+' | ' else '' endif
    +if days_supply > 0 then 'Days Supply: '+string(days_supply)+' | ' else '' endif
    +if copay_tier > 0 then 'Tier: '+string(copay_tier)+' | ' else '' endif
    +if max_copay_tier > 0 then 'Max. Tier: '+string(max_copay_tier)+' | ' else '' endif 
    +If isnull(pharmacy_type,'') = '' then '' else 'Pharmacy Type: ' + (case pharmacy_type when 'A' then 'Any (A)' when 'M' then 'Mail Order (M)' when 'R' then 'Retail (R)' when 'S' then 'Specialty (S)' when 'L' then 'Long-Term Care(L)' else '' end) endif as coverage_desc ,
    pharmacy_type as pharmacy_type
    from formulary_copay_sl_detail,formulary_copay_header
    where formulary_copay_sl_detail.record_id = formulary_copay_header.record_id
    and formulary_copay_header.sender_id = as_sender_id
    and formulary_copay_sl_detail.copay_id = as_copay_id
    and formulary_copay_sl_detail.formulary_status like ls_formulary_status_code
    and ls_formulary_status_code <> '0' 
    and not exists (select a.record_id  
 from formulary_copay_ds_detail a ,formulary_copay_header b
    where a.record_id = b.record_id
    and b.sender_id = as_sender_id
    and a.copay_id = as_copay_id
    and a.product_id IN ( select ndc from ndc_mst where PLBLR ='0' and REPACK = '0' and ud = '0' and OBSDTEC ='00000000'   and    ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) ))
    and ls_formulary_status_code <> '0' ) 
 
 union all 
  select top 1
    31 as sort_order,
    'Alternative Drug' as group_name,
    'DONOTDISPLAY' as coverage_type,
    'Available' as coverage_desc,
    '' as pharmacy_type
    from formulary_alternative_detail,formulary_alternative_header
    where formulary_alternative_detail.record_id = formulary_alternative_header.record_id
    and formulary_alternative_header.sender_id = as_sender_id
    and formulary_alternative_detail.alternative_id = as_alternative_id
    and formulary_alternative_detail.product_id  IN ( select ndc from ndc_mst where PLBLR ='0' and REPACK = '0' and ud = '0' and OBSDTEC ='00000000'  and    ndc in(select ndc from ndc_medication_lnk where medid in (select medid from ndc_medication_lnk where ndc  =as_product_id ) )) union all
  select top 1
    20 as sort_order,
    'Coverage' as group_name,
    'DONOTDISPLAY' as coverage_type,
    if alert_flag = 'Y' then 'Restricted' else 'Available' endif  as coverage_desc ,
    '' as pharmacy_type
    from pr_surescript_formulary_coverage(ae_patient_id,ae_eligibility_id,as_sender_id,as_product_id,as_coverage_id,as_alternative_id,as_copay_id,as_formulary_id)
    order by coverage_desc desc
end;
